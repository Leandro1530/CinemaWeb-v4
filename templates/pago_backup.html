{% extends "base.html" %}
{% block title %}Pago de entradas | Cinema3D{% endblock %}

{% block head_extras %}
<style>
  /* ===== Pago con tarjeta: capa visual coherente con modern-ui.css ===== */
  .paycard-wrap { max-width: 1100px; margin-inline: auto; }
  .paycard-main { padding: clamp(16px, 2.8vw, 28px); }

  .paycard-header { text-align:center; margin-bottom: clamp(14px,2.5vw,22px); }
  .paycard-title { font-size: clamp(1.4rem,2.2vw,2rem); font-weight: 800; margin: 0 0 .25rem; }
  .paycard-sub { color: var(--muted); margin: 0; }

  /* Grid del formulario */
  .payment-form-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-top: 14px;
  }
  .form-group{ display:flex; flex-direction:column; gap:.4rem; }
  .form-group.full-width { grid-column: 1 / -1; }

  .form-label { color: var(--text); font-weight: 600; font-size: .92rem; }

  .form-input {
    width: 100%;
    padding: .65rem .8rem;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.12);
    background: #0f1428;
    color: #e5e7eb;
    font-size: .95rem;
    transition: border-color .2s ease, background .2s ease, box-shadow .2s ease;
  }
  .form-input:focus{ outline:none; border-color:#4f6df5; background:#121936; box-shadow: 0 0 0 2px rgba(79,109,245,.12); }

  #brand_icon svg {
    width: 28px; height: 18px;
    display:inline-block; background:#fff;
    border-radius: 3px; padding: 1px; margin-left: .4rem;
    vertical-align: -3px;
  }

  .amount-highlight {
    background: rgba(34, 197, 94, 0.10);
    border: 1px solid rgba(34, 197, 94, 0.35);
    color: #22c55e; font-weight: 800; text-align: center;
    cursor: not-allowed;
  }

  .form-actions {
    display:flex; gap:12px; justify-content:center; margin-top: 12px;
    grid-column: 1 / -1;
  }

  /* Alertas (usa tu misma l√≥gica) */
  .alert{ padding:.9rem 1rem; border-radius:12px; margin-bottom:1rem; border:1px solid transparent; }
  .alert-danger{ background:rgba(239,68,68,.1); border-color:rgba(239,68,68,.35); color:#fca5a5; }
  .alert-success{ background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.35); color:#86efac; }

  /* Responsive */
  @media (max-width: 1024px) {
    .payment-form-grid { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 768px) {
    .payment-form-grid { grid-template-columns: 1fr; gap: 12px; }
    .form-actions { flex-direction: column; }
  }
</style>
{% endblock %}

{% block content %}
<div class="page-container paycard-wrap">
  <!-- Hero -->
  <section class="hero card">
    <div class="paycard-header">
      <h1 class="paycard-title">Pago de entradas</h1>
      <p class="paycard-sub">Seguro ‚Ä¢ R√°pido ‚Ä¢ Comprobantes por email</p>
    </div>
  </section>

  <!-- Mensajes -->
  {% if errores %}
    <div class="alert alert-danger">
      <ul style="margin:0; padding-left:1.1rem;">
        {% for error in errores %}<li>{{ error }}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}
  {% if exito %}
    <div class="alert alert-success">{{ exito }}</div>
  {% endif %}

  <!-- Formulario -->
  <section class="card form-card paycard-main">
    <form id="form-pago" method="POST" action="{{ url_for('pago.pago') }}" novalidate class="payment-form-grid" autocomplete="off">
      <!-- EMAIL (para comprobante) -->
      <div class="form-group full-width">
        <label for="email" class="form-label">üìß Email</label>
        <input id="email" name="email" type="email" maxlength="30" autocomplete="email"
               value="{{ email|default('') }}" placeholder="tu@email.com"
               required class="form-input">
      </div>

      <!-- NOMBRE EN TARJETA -->
      <div class="form-group">
        <label for="nombre_tarjeta" class="form-label">üë§ Nombre en la tarjeta</label>
        <input id="nombre_tarjeta" name="nombre_tarjeta" type="text"
               minlength="2" maxlength="26" required autocomplete="cc-name"
               pattern="[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√± ]{2,26}"
               value="{{ nombre_tarjeta|default('') }}" placeholder="JUAN PEREZ" class="form-input">
      </div>

      <!-- N√öMERO DE TARJETA -->
      <div class="form-group">
        <label for="pan" class="form-label">üí≥ N√∫mero de tarjeta <span id="brand_icon"></span></label>
        <input id="pan" name="pan" type="text" inputmode="numeric" autocomplete="cc-number"
               placeholder="1234 5678 9012 3456" pattern="[\d\s]{19}" required class="form-input">
      </div>

      <!-- CVV -->
      <div class="form-group">
        <label for="cvv" class="form-label">üîí CVV</label>
        <input id="cvv" name="cvv" type="password" inputmode="numeric"
               maxlength="3" placeholder="123" required pattern="\d{3}" autocomplete="cc-csc" class="form-input">
      </div>

      <!-- MES -->
      <div class="form-group">
        <label for="exp_mes" class="form-label">üìÖ Mes</label>
        <input id="exp_mes" name="exp_mes" type="text" inputmode="numeric"
               maxlength="2" placeholder="12" required pattern="(0[1-9]|1[0-2])" class="form-input">
      </div>

      <!-- A√ëO -->
      <div class="form-group">
        <label for="exp_anio" class="form-label">üìÖ A√±o</label>
        <input id="exp_anio" name="exp_anio" type="text" inputmode="numeric"
               maxlength="4" placeholder="2025" required pattern="\d{4}" class="form-input">
      </div>

      <!-- TOTAL -->
      <div class="form-group">
        <label for="monto_view" class="form-label">üíµ Total a pagar</label>
        <input id="monto_view" type="text" required value="${{ "%.0f"|format(total) }}" readonly class="form-input amount-highlight" aria-readonly="true">
        <input id="monto" name="monto" type="hidden" value="{{ monto_sugerido }}">
      </div>

      <!-- Acciones -->
      <div class="form-actions full-width">
        <a class="btn-ghost" href="{{ url_for('main.bienvenida') }}">‚Üê Volver</a>
        <button class="btn-primary" type="submit">Procesar pago ‚Üí</button>
      </div>
    </form>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
  // ===== Monto solo lectura (el servidor define el valor) =====
  (function(){
    const montoView = document.getElementById('monto_view');
    if (montoView){
      montoView.addEventListener('focus', ()=>montoView.blur());
      montoView.addEventListener('keydown', (e)=>e.preventDefault());
    }
  })();

  // ===== Nombre en may√∫sculas y sin caracteres inv√°lidos =====
  (function(){
    const inputNombre = document.getElementById('nombre_tarjeta');
    if (!inputNombre) return;
    inputNombre.addEventListener('input', ()=>{
      inputNombre.value = inputNombre.value.replace(/[^A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√± ]/g,'').toUpperCase();
    });
  })();

  // ===== CVV, Mes y A√±o con longitud y formato =====
  (function(){
    const cvv = document.getElementById('cvv');
    const expMes = document.getElementById('exp_mes');
    const expAnio = document.getElementById('exp_anio');

    if (cvv){
      cvv.addEventListener('input', ()=>{ cvv.value = cvv.value.replace(/\D/g,'').slice(0,3); });
    }
    if (expMes){
      expMes.addEventListener('input', ()=>{
        expMes.value = expMes.value.replace(/\D/g,'').slice(0,2);
        if (expMes.value.length === 2){
          let m = parseInt(expMes.value||'0',10);
          if (m<1) m=1; if (m>12) m=12;
          expMes.value = String(m).padStart(2,'0');
          if (expAnio) expAnio.focus();
        }
      });
    }
    if (expAnio){
      expAnio.addEventListener('input', ()=>{
        expAnio.value = expAnio.value.replace(/\D/g,'').slice(0,4);
        if (expAnio.value.length === 4 && cvv) cvv.focus();
      });
    }
  })();

  // ===== PAN con formateo y detecci√≥n de marca =====
  (function(){
    const pan = document.getElementById('pan');
    const brandIcon = document.getElementById('brand_icon');
    if (!pan || !brandIcon) return;

    const icons = {
      VISA: `<svg viewBox="0 0 48 32"><path fill="#1a1f71" d="M22.3 22.9l2.6-13.8h4.2l-2.6 13.8zM34.5 9.1c-.8-.3-2-.6-3.5-.6-3.9 0-6.6 2-6.6 5 0 2.2 2 3.4 3.6 4.2 1.6.8 2.1 1.3 2.1 2 0 1.1-1.3 1.6-2.5 1.6-1.7 0-2.6-.3-4-.9l-.5-.2-.6 3.3c1 .4 2.8.7 4.7.7 4.4 0 7.2-2 7.2-5.1 0-1.7-1.1-3-3.4-4.2-1.4-.7-2.3-1.2-2.3-2 0-.7.7-1.4 2.3-1.4 1.3 0 2.3.3 3 .6l.4.2.6-3.2M38.7 9.1h-3.2c-1 0-1.8.3-2.2 1.3l-6.2 12.5h4.4l.9-2.3h5.4c.1.6.5 2.3.5 2.3h3.9L38.7 9.1M14.7 9.1l-4.1 9.4-.4-1.9c-1-2.3-2.9-4.8-5.3-6.4L8.5 23h4.3l6.4-13.9h-4.5z"/></svg>`,
      MASTERCARD: `<svg viewBox="0 0 48 32"><circle cx="19" cy="16" r="10" fill="#eb001b"/><circle cx="29" cy="16" r="10" fill="#f79e1b"/><path d="M24 26a10 10 0 0 0 0-20 10 10 0 0 0 0 20z" fill="#ff5f00"/></svg>`,
      DESCONOCIDA: ``
    };
    function detectBrand(digits){
      if(/^4\d{0,15}$/.test(digits)) return 'VISA';
      if(/^(5[1-5]\d{0,14}|2(2[2-9]\d{0,12}|[3-6]\d{0,13}|7[01]\d{0,12}|720\d{0,12}))$/.test(digits)) return 'MASTERCARD';
      return 'DESCONOCIDA';
    }

    pan.addEventListener('input', ()=>{
      let digits = pan.value.replace(/\D/g,'').slice(0,16);
      pan.value = digits.replace(/(.{4})/g,'$1 ').trim();
      const brand = detectBrand(digits);
      brandIcon.innerHTML = brand === 'DESCONOCIDA' ? '' : icons[brand];
    });
  })();
</script>
{% endblock %}
