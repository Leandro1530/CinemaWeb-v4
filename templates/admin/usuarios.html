{% extends "admin_base.html" %}
{% block title %}Gestionar Usuarios - Admin Cinema3D{% endblock %}

{% block head_extras %}
<style>
  .admin-users-wrap{
    max-width:1400px;margin-inline:auto;background:rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.3);
    backdrop-filter:blur(14px);padding:clamp(1rem,2vw,2rem);
  }
  .header-flex{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:1.5rem;}
  .header-flex h1{margin:0;font-size:1.6rem;font-weight:800;}

  .search-filters{background:rgba(255,255,255,.02);border-radius:12px;padding:1rem;margin-bottom:1.5rem;display:flex;gap:1rem;flex-wrap:wrap;align-items:center;}
  .search-input,.filter-select{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:.7rem .9rem;color:#fff;font-size:.9rem;}
  .search-input::placeholder{color:#9ca3af;}

  .users-table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden;}
  .users-table th,.users-table td{ text-align:left; padding:1rem; border-bottom:1px solid rgba(255,255,255,.08); }
  .users-table th{ color:#9fb1ff; font-size:.85rem; text-transform:uppercase; letter-spacing:.5px; background:rgba(255,255,255,.03); }
  .users-table td{ color:#e5e7eb; font-size:.9rem; }
  .users-table tbody tr:hover td{ background:rgba(255,255,255,.03); }

  .role-badge{ padding:.25rem .75rem; border-radius:20px; font-size:.75rem; font-weight:700; text-transform:uppercase; }
  .role-admin{background:rgba(239,68,68,.2);color:#ef4444;}
  .role-usuario{background:rgba(34,197,94,.2);color:#22c55e;}

  .actions{display:flex;gap:.5rem;align-items:center;}
  .btn-small{ width:32px; height:32px; border:none; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:1rem; cursor:pointer; transition:all .25s; }
  .btn-edit{background:rgba(59,130,246,.2);color:#3b82f6;}
  .btn-edit:hover{background:rgba(59,130,246,.3);transform:scale(1.1);}
  .btn-delete{background:rgba(239,68,68,.2);color:#ef4444;}
  .btn-delete:hover{background:rgba(239,68,68,.3);transform:scale(1.1);}

  .no-results{text-align:center;padding:3rem;color:#9ca3af;}
  .alert{padding:1rem;border-radius:10px;margin-bottom:1rem;}
  .alert-success{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);color:#86efac;}

  .modal{ display:none; position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,.8); }
  .modal-content{ background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); border-radius:16px; backdrop-filter:blur(18px); margin:10% auto; max-width:380px; padding:2rem; text-align:center; }
  .modal-content h3{color:#fff;margin-bottom:1rem;}
  .modal-content p{color:#9ca3af;margin-bottom:2rem;}
  .modal-actions{display:flex;gap:1rem;justify-content:center;}
  .btn-cancel{background:rgba(107,114,128,.2);color:#9ca3af;padding:.7rem 1.4rem;border:none;border-radius:8px;cursor:pointer;}
  .btn-confirm{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;padding:.7rem 1.4rem;border:none;border-radius:8px;cursor:pointer;}

  @media(max-width:768px){ .search-filters{flex-direction:column;} }
</style>
{% endblock %}

{% block admin_actions %}
    <a href="{{ url_for('admin.nuevo_usuario') }}" class="btn-primary">‚ûï Nuevo Usuario</a>
{% endblock %}

{% block admin_content %}
<section class="admin-users-wrap">
  <div class="header-flex"><h1>Gestionar Usuarios</h1></div>

  {% with messages = get_flashed_messages() %}
    {% if messages %}{% for message in messages %}<div class="alert alert-success">{{ message }}</div>{% endfor %}{% endif %}
  {% endwith %}

  <div class="search-filters">
    <input type="text" id="searchInput" class="search-input" placeholder="Buscar por email o nombre...">
    <select id="roleFilter" class="filter-select">
      <option value="">Todos los roles</option>
      <option value="admin">Administradores</option>
      <option value="usuario">Usuarios</option>
    </select>
  </div>

  {% if usuarios %}
  <table class="users-table">
    <thead><tr><th>ID</th><th>Email</th><th>Nombre</th><th>Rol</th><th>Fecha Registro</th><th>Acciones</th></tr></thead>
    <tbody id="usersTableBody">
      {% for usuario in usuarios %}
      <tr data-email="{{ usuario.email.lower() }}" data-nombre="{{ (usuario.nombre or '').lower() }}" data-rol="{{ usuario.rol }}">
        <td>{{ usuario.id }}</td>
        <td>{{ usuario.email }}</td>
        <td>{{ usuario.nombre or '-' }}</td>
        <td><span class="role-badge role-{{ usuario.rol }}">{{ usuario.rol }}</span></td>
        <td>{{ usuario.created_at[:10] if usuario.created_at else '-' }}</td>
        <td>
          <div class="actions">
            <a href="{{ url_for('admin.editar_usuario', user_id=usuario.id) }}" class="btn-small btn-edit" title="Editar">‚úèÔ∏è</a>
            {% if usuario.id != session.user_id %}
              <button class="btn-small btn-delete" onclick="confirmDelete('{{ usuario.id }}', '{{ usuario.email }}')" title="Eliminar">üóëÔ∏è</button>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <div class="no-results"><p>No hay usuarios registrados.</p></div>
  {% endif %}
</section>

<div id="deleteModal" class="modal">
  <div class="modal-content">
    <h3>Confirmar Eliminaci√≥n</h3>
    <p id="deleteMessage">¬øEst√°s seguro de que deseas eliminar este usuario?</p>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeDeleteModal()">Cancelar</button>
      <form id="deleteForm" method="POST" style="display:inline;">
        <button type="submit" class="btn-confirm">Eliminar</button>
      </form>
    </div>
  </div>
</div>

<script>
  document.getElementById('searchInput').addEventListener('input', filterUsers);
  document.getElementById('roleFilter').addEventListener('change', filterUsers);

  function filterUsers(){
    const search=(document.getElementById('searchInput').value||'').toLowerCase();
    const role=document.getElementById('roleFilter').value;
    const rows=document.querySelectorAll('#usersTableBody tr');
    rows.forEach(r=>{
      const email=r.dataset.email||'', nombre=r.dataset.nombre||'', rol=r.dataset.rol||'';
      const match=(email.includes(search)||nombre.includes(search)) && (!role||rol===role);
      r.style.display=match?'':'none';
    });
  }

  function confirmDelete(id,email){
    document.getElementById('deleteMessage').textContent=`¬øEliminar usuario "${email}"?`;
    document.getElementById('deleteForm').action='{{ url_for("admin.eliminar_usuario", user_id=0)[:-1] }}'.replace(/0$/, id);
    document.getElementById('deleteModal').style.display='block';
  }
  function closeDeleteModal(){ document.getElementById('deleteModal').style.display='none'; }
  window.onclick=e=>{ const m=document.getElementById('deleteModal'); if(e.target===m) m.style.display='none'; }
</script>
{% endblock %}