{% extends "admin_base.html" %}
{% block title %}{% if usuario %}Editar Usuario{% else %}Nuevo Usuario{% endif %} - Admin Cinema3D{% endblock %}

{% block head_extras %}
<style>
  .admin-form-wrap{
    max-width:900px;margin-inline:auto;background:rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.1);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.35);
    backdrop-filter:blur(14px);padding:clamp(16px,2.5vw,32px);
  }
  .form-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:18px;}
  .form-header h1{margin:0;font-size:clamp(1.4rem,2vw,1.8rem);font-weight:800;}
  .btn-secondary{border:1px solid rgba(255,255,255,.2);color:#9ca3af;text-decoration:none;padding:.7rem 1.3rem;border-radius:10px;transition:all .2s;}
  .btn-secondary:hover{background:rgba(255,255,255,.1);color:#fff;}

  .form-section{margin-bottom:2rem;}
  .form-section h3{color:#e5e7eb;font-size:1.1rem;font-weight:700;margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px solid rgba(255,255,255,.1);}
  .form-grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));}
  .form-group{margin-bottom:1.2rem;}
  label{display:block;color:#e5e7eb;font-weight:600;font-size:.9rem;margin-bottom:.4rem;}
  label .required{color:#ef4444;}
  input,select{
    width:100%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);
    border-radius:8px;padding:.75rem;color:#fff;font-size:.95rem;transition:all .2s;
  }
  input:focus,select:focus{border-color:#4f6df5;box-shadow:0 0 0 2px rgba(79,109,245,.15);outline:none;}
  .help-text{font-size:.8rem;color:#9ca3af;margin-top:.25rem;}

  .alert{padding:.9rem 1rem;border-radius:10px;margin-bottom:1rem;}
  .alert-success{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);color:#86efac;}

  .password-section{border-top:1px solid rgba(255,255,255,.1);padding-top:1.2rem;margin-top:1.4rem;}
  .checkbox-group{display:flex;align-items:center;gap:.5rem;margin-bottom:1rem;}
  .checkbox{width:18px;height:18px;}
  .checkbox-label{color:#e5e7eb;font-size:.9rem;cursor:pointer;}

  .actions{display:flex;gap:1rem;justify-content:flex-end;flex-wrap:wrap;margin-top:1.5rem;}
  .btn-primary{background:linear-gradient(135deg,#4f6df5,#3b56e8);color:#fff;border:none;padding:.8rem 1.3rem;border-radius:10px;font-weight:700;cursor:pointer;transition:transform .2s,box-shadow .2s;}
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(0,0,0,.3);}
  .btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;border:none;padding:.8rem 1.3rem;border-radius:10px;font-weight:700;cursor:pointer;transition:transform .2s,box-shadow .2s;}
  .btn-danger:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(239,68,68,.35);}

  @media(max-width:640px){ .form-header{flex-direction:column;align-items:stretch;} .actions{flex-direction:column;align-items:stretch;} }
</style>
{% endblock %}

{% block admin_actions %}
  <a href="{{ url_for('admin.usuarios') }}" class="btn-exit">‚Üê Volver a Usuarios</a>
{% endblock %}

{% block admin_content %}
<section class="admin-form-wrap">
  <div class="form-header"><h1>{% if usuario %}Editar Usuario{% else %}Nuevo Usuario{% endif %}</h1></div>

  {% with messages = get_flashed_messages() %}
    {% if messages %}{% for message in messages %}<div class="alert alert-success">{{ message }}</div>{% endfor %}{% endif %}
  {% endwith %}

  <form method="POST" id="userForm">
    <!-- Informaci√≥n de Cuenta -->
    <div class="form-section">
      <h3>Informaci√≥n de Cuenta</h3>
      
      <div class="form-group">
        <label for="email">Email <span class="required">*</span></label>
        <input id="email" name="email" type="email" required value="{{ usuario.email if usuario else '' }}" placeholder="usuario@ejemplo.com">
        <div class="help-text">El email se usa como nombre de usuario</div>
      </div>

      <div class="form-group">
        <label for="rol">Rol <span class="required">*</span></label>
        <select id="rol" name="rol" required>
          <option value="usuario" {% if not usuario or usuario.rol == 'usuario' %}selected{% endif %}>Usuario</option>
          <option value="admin" {% if usuario and usuario.rol == 'admin' %}selected{% endif %}>Administrador</option>
        </select>
        <div class="help-text">Los administradores pueden gestionar usuarios y funciones</div>
      </div>
    </div>

    <!-- Informaci√≥n Personal -->
    <div class="form-section">
      <h3>Informaci√≥n Personal</h3>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="nombre">Nombre</label>
          <input id="nombre" name="nombre" type="text" value="{{ usuario.nombre if usuario else '' }}" placeholder="Nombre">
        </div>

        <div class="form-group">
          <label for="apellido">Apellido</label>
          <input id="apellido" name="apellido" type="text" value="{{ usuario.apellido if usuario else '' }}" placeholder="Apellido">
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="tipo_documento">Tipo de Documento</label>
          <select id="tipo_documento" name="tipo_documento">
            <option value="DNI" {% if not usuario or usuario.tipo_documento == 'DNI' %}selected{% endif %}>DNI</option>
            <option value="Pasaporte" {% if usuario and usuario.tipo_documento == 'Pasaporte' %}selected{% endif %}>Pasaporte</option>
            <option value="CI" {% if usuario and usuario.tipo_documento == 'CI' %}selected{% endif %}>C√©dula de Identidad</option>
          </select>
        </div>

        <div class="form-group">
          <label for="nro_documento">N√∫mero de Documento</label>
          <input id="nro_documento" name="nro_documento" type="text" value="{{ usuario.nro_documento if usuario else '' }}" placeholder="12345678">
        </div>
      </div>

      <div class="form-group">
        <label for="telefono">Tel√©fono</label>
        <input id="telefono" name="telefono" type="tel" value="{{ usuario.telefono if usuario else '' }}" placeholder="+54 9 11 1234-5678">
      </div>
    </div>

    <!-- Direcci√≥n -->
    <div class="form-section">
      <h3>Direcci√≥n</h3>
      
      <div class="form-group">
        <label for="direccion">Calle y N√∫mero</label>
        <input id="direccion" name="direccion" type="text" value="{{ usuario.direccion if usuario else '' }}" placeholder="Av. Corrientes 1234">
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="ciudad">Ciudad</label>
          <input id="ciudad" name="ciudad" type="text" value="{{ usuario.ciudad if usuario else '' }}" placeholder="Buenos Aires">
        </div>

        <div class="form-group">
          <label for="provincia">Provincia</label>
          <input id="provincia" name="provincia" type="text" value="{{ usuario.provincia if usuario else '' }}" placeholder="CABA">
        </div>

        <div class="form-group">
          <label for="codigo_postal">C√≥digo Postal</label>
          <input id="codigo_postal" name="codigo_postal" type="text" value="{{ usuario.codigo_postal if usuario else '' }}" placeholder="1414">
        </div>
      </div>
    </div>

    <!-- Contrase√±a -->
    <div class="password-section">
      <h3>{% if usuario %}Cambiar Contrase√±a{% else %}Contrase√±a{% endif %}</h3>
      {% if usuario %}
      <div class="checkbox-group">
        <input type="checkbox" class="checkbox" id="change_password" onchange="togglePassword()">
        <label for="change_password" class="checkbox-label">Cambiar contrase√±a</label>
      </div>
      {% endif %}

      <div id="password-fields" {% if usuario %}style="display:none"{% endif %}>
        <div class="form-group">
          <label for="password">{% if usuario %}Nueva Contrase√±a{% else %}Contrase√±a <span class="required">*</span>{% endif %}</label>
          <input id="password" name="password" type="password" {% if not usuario %}required{% endif %} minlength="6" placeholder="M√≠nimo 6 caracteres">
        </div>
        <div class="form-group">
          <label for="confirm_password">Confirmar {% if usuario %}Nueva {% endif %}Contrase√±a</label>
          <input id="confirm_password" name="confirm_password" type="password" {% if not usuario %}required{% endif %} placeholder="Repetir contrase√±a">
        </div>
      </div>
    </div>

    <div class="actions">
      {% if usuario and usuario.id %}
        <button type="button" class="btn-danger" onclick="confirmDelete({{ usuario.id }})">üóëÔ∏è Eliminar</button>
      {% endif %}
      <button type="submit" class="btn-primary">{% if usuario %}üíæ Actualizar{% else %}‚ûï Crear{% endif %}</button>
    </div>
  </form>
</section>

<script>
function togglePassword(){
  const c=document.getElementById('change_password');
  const fields=document.getElementById('password-fields');
  const p=document.getElementById('password'), cp=document.getElementById('confirm_password');
  if(c.checked){ fields.style.display='block'; p.required=true; cp.required=true; }
  else{ fields.style.display='none'; p.required=false; cp.required=false; p.value=''; cp.value=''; }
}

function confirmDelete(userId){
  if(confirm('¬øEliminar este usuario? Esta acci√≥n no se puede deshacer.')){
    // Crear formulario din√°micamente
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/admin/usuarios/eliminar/' + userId;
    form.style.display = 'none';
    
    // Agregar al body y enviar
    document.body.appendChild(form);
    
    // Debug: verificar que la URL es correcta
    console.log('Eliminando usuario con URL:', form.action);
    
    form.submit();
  }
}

document.getElementById('userForm').addEventListener('submit', e=>{
  const p=document.getElementById('password').value, cp=document.getElementById('confirm_password').value;
  if(p && p!==cp){ e.preventDefault(); alert('Las contrase√±as no coinciden.'); }
});

document.getElementById('confirm_password').addEventListener('input', function(){
  const p=document.getElementById('password').value;
  this.style.borderColor=(this.value && this.value!==p)?'#ef4444':'rgba(255,255,255,.1)';
});
</script>
{% endblock %}